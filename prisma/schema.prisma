generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["omitApi"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  name          String
  email         String    @unique
  emailVerified DateTime?
  password      String
  phone         String

  bio   String?
  image String?
  year  String

  role        Role      @default(USER)
  memberSince DateTime?
  position    String?

  totalActivityPoints Int @default(0)

  // Important
  VerificationToken VerificationToken[]
  RefreshToken      RefreshToken[]
  Payment           Payment[]

  branchId String
  Branch   Branch @relation(fields: [branchId], references: [id])

  UserLink      UserLink[]
  ActivityPoint ActivityPoint[]

  Team        Team[]
  Attendance  Attendance[]
  Certificate Certificate[]

  Organiser Organiser[]

  QuizResponse QuizResponse[]
  UserFeedback UserFeedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id      String           @id @unique @default(cuid())
  revoked Boolean          @default(false)
  type    VerificationType @default(EMAIL_VERIFICATION)

  userId Int
  User   User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RefreshToken {
  id          String  @id @unique
  hashedToken String
  revoked     Boolean @default(false)

  userId Int
  User   User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([id, hashedToken])
}

model UserLink {
  id       String @id @default(cuid())
  linkName String
  url      String

  userId Int?
  User   User? @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Branch {
  id       String @id @default(cuid())
  nickName String
  name     String

  User User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActivityPoint {
  id    String  @id @default(cuid())
  point Int
  name  String? @default("Event")

  User User[]

  eventId Int?
  Event   Event? @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Event {
  id          Int     @id @default(autoincrement())
  name        String
  imgSrc      String?
  description String?
  venue       String?

  eventType EventType
  category  EventCategory

  fromDate DateTime
  toDate   DateTime
  deadline DateTime?

  maxTeams    Int @default(0) // 0 for unlimited
  minTeamSize Int @default(1)
  maxTeamSize Int @default(1)

  amount Int @default(0) // 0 for free events

  state    EventState @default(DRAFT)
  isLegacy Boolean    @default(false)

  ActivityPoint ActivityPoint[]
  Certificate   Certificate[]

  Team       Team[]
  Attendance Attendance[]

  Organiser Organiser[]
  Winner    Winner[]

  FeedbackTemplate FeedbackTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Organiser {
  id String @id @default(cuid())

  userId Int
  User   User @relation(fields: [userId], references: [id])

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId])
  @@index([userId, eventId])
}

model Team {
  id          Int     @id @default(autoincrement())
  name        String
  isConfirmed Boolean @default(false)
  hasAttended Boolean @default(false) // entire team has attended

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id])

  Members User[]

  Winner Winner?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Attendance {
  id          String  @id @default(cuid())
  hasAttended Boolean @default(false)

  userId Int
  User   User @relation(fields: [userId], references: [id])

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventId])
  @@index([userId, eventId])
}

model Winner {
  id         String     @id @default(cuid())
  winnerType WinnerType

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id])

  teamId Int  @unique
  Team   Team @relation(fields: [teamId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, teamId])
  @@index([eventId, teamId])
}

model Certificate {
  id              String          @id @default(cuid())
  issuedOn        DateTime
  certificateType CertificateType

  userId Int
  User   User @relation(fields: [userId], references: [id])

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, userId])
  @@index([userId, eventId])
}

model FeedbackTemplate {
  id            String                @id @default(cuid())
  templateState FeedbackTemplateState @default(DRAFT)

  eventId Int
  Event   Event @relation(fields: [eventId], references: [id])

  Questions   String[]
  AnswersType AnswerType[]

  UserFeedback UserFeedback[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserFeedback {
  userId Int
  User   User @relation(fields: [userId], references: [id])

  feedbackTemplateId String
  FeedbackTemplate   FeedbackTemplate @relation(fields: [feedbackTemplateId], references: [id])

  Answers String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([userId, feedbackTemplateId])
  @@unique([userId, feedbackTemplateId])
  @@index([userId, feedbackTemplateId])
}

model Payment {
  id          String @id @default(cuid())
  paymentName String

  razorpayPaymentId String
  razorpayOrderId   String
  razorpaySignature String

  userId Int
  User   User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, razorpayPaymentId])
}

model Quiz {
  id        String    @id @default(cuid())
  title     String
  timeLimit Int // in seconds
  state     QuizState @default(DRAFT)
  questions Json
  maxScore  Int       @default(0)

  Responses QuizResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt()
}

model QuizResponse {
  id         String @id @default(cuid())
  answers    Json
  totalScore Int    @default(0)

  userId Int
  User   User @relation(fields: [userId], references: [id])

  quizId String
  quiz   Quiz   @relation(fields: [quizId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt()
}

enum Role {
  USER
  MEMBER
  CORE
  ADMIN
}

enum EventType {
  SOLO
  TEAM
}

enum EventCategory {
  WORKSHOP
  COMPETITION
  HACKATHON
  SPECIAL
}

enum EventState {
  DRAFT
  PUBLISHED
  COMPLETED
}

enum WinnerType {
  WINNER
  RUNNER_UP
  SECOND_RUNNER_UP
}

enum CertificateType {
  WINNER
  RUNNER_UP
  SECOND_RUNNER_UP
  PARTICIPATION
}

enum AnswerType {
  BOOLEAN
  RATING
  COMMENT
}

enum FeedbackTemplateState {
  DRAFT
  PUBLISHED
}

enum VerificationType {
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum QuizState {
  DRAFT
  PUBLISHED
  LIVE
  COMPLETED
}
